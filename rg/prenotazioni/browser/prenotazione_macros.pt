<!-- The macro used to go navigate through the weeks -->
<metal:macro metal:define-macro="week_navigator" i18n:domain="rg.prenotazioni">
  <a id="prevWeekLink" href="#"rel="nofollow"
     tal:attributes="href string:${request/getURL}?data=${view/prev_week}"
     >&larr; settimana precedente</a>
  <strong><tal:month i18n:domain="plonelocales"
                     i18n:translate=""
                     content="view/actual_translated_month" />
          <tal:year content="view/actual_date/year" /></strong>
  <a id="nextWeekLink" href="#" rel="nofollow"
     tal:attributes="href string:${request/getURL}?data=${view/next_week}"
     >settimana successiva &rarr;</a>
</metal:macro>

<!-- The macro that renders a period of the the day (morning, afternoon) -->
<metal:macro metal:define-macro="day_period" i18n:domain="rg.prenotazioni">
  <tr>
    <tal:days repeat="day view/actual_week_days">
      <td class="day"
          tal:define="time_range python:view.get_day_ranges(day)[period]"
          tal:attributes="class python:day==view.actual_date and 'day selected' or 'day'">
        <ul class="plain period" 
            tal:define="bookings python:view.prenotazioni.get_bookings_in_day(day)">
          <li tal:condition="python:all(time_range)">
            From <tal:from replace="python:time_range[0]" />
            to <tal:from replace="python:time_range[1]" />
          </li>
          <li tal:repeat="booking bookings">
            <div tal:define="booking booking/getObject">
              <h3>
                <a href="" 
                   tal:attributes="href booking/absolute_url"
                   tal:content="booking/Title">
                </a>
              </h3>
              <p tal:content="booking/getData_prenotazione"></p>
              <p tal:content="booking/getData_scadenza"></p>
            </div>
          </li>
        </ul>
      </td>
    </tal:days>
  </tr>
  <tr>
    <tal:days repeat="day view/actual_week_days">
      <td tal:define="booking_url python:view.get_booking_url(day, period);">
        <a rel="nofollow"
           tal:attributes="href booking_url"
           tal:condition="booking_url"
           i18n:translate="book_first_available_slot"
           >Book the first available slot
        </a>
      </td>
      </tal:days>
   </tr>
</metal:macro>

<!-- A slot for booking -->
<metal:macro metal:define-macro="booking_slots" i18n:domain="rg.prenotazioni">
  <dl tal:define="data_ora python:day[1].strftime('%Y/%m/%d')+' '+orario+':00';
                  has_free_slots python:view.conflict_manager.has_free_slots(data_ora);">

    <metal:booking_slots metal:use-macro="prenotazione_macros/desc_term" />
    <dd tal:condition="not:has_free_slots">
        <span class="slotOccupato">Occupato</span>
    </dd>
  </dl>
</metal:macro>

<!-- posso vedere tutte le prenotazioni in quanto ho permessi di edit-->
<metal:macro metal:define-macro="booking_slots_edit" i18n:domain="rg.prenotazioni">
  <dl tal:define="data_ora python:day[1].strftime('%Y/%m/%d')+' '+orario+':00';
                  has_free_slots python:view.conflict_manager.has_free_slots(data_ora);">

    <metal:booking_slots metal:use-macro="prenotazione_macros/desc_term" />
    <tal:repeat repeat="prenotazione prenotazioni">
      <dd>
        <tal:display condition="not:uid_spostamento">
            <!-- esiste la prenotazione -->
            <a href="" class="state-pending"
                tal:attributes="href prenotazione/getURL;
                class string:state-${prenotazione/review_state}"
                tal:content="prenotazione/Title">Mario Rossi</a>
            <!-- cambia data -->
            <a href="" class="modificaPrenotazione" title="Cambia data"
                tal:attributes="href python:here_url+'/spostaPrenotazione?UID='+prenotazione.UID">sposta</a>
        </tal:display>
      </dd>
    </tal:repeat>
  </dl>
</metal:macro>

<metal:macro metal:define-macro="desc_term" i18n:domain="rg.prenotazioni">
    <dt tal:define="show_add_button python:view.show_add_button(data_ora);">
      <tal:orario content="orario">8:00</tal:orario>
      <tal:has_space condition="has_free_slots">
        <a href="" class="aggiungiPrenotazione" title="Richiedi prenotazione"
            tal:condition="python:view.show_add_button(data_ora)"
            tal:attributes="href python:here_url+'/creaPrenotazione?form.booking_date='+data_ora">+</a>
        <tal:sposta condition="uid_spostamento">
          <a href="" class="modificaPrenotazione" title="Sposta qui"
          tal:attributes="href python:here_url+'/fissaPrenotazione?data_prenotazione='+data_ora">sposta qui</a>
        </tal:sposta>
      </tal:has_space>
    </dt>
</metal:macro>