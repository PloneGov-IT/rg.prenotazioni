<!-- The macro used to go navigate through the weeks -->
<metal:macro metal:define-macro="week_navigator" i18n:domain="rg.prenotazioni">
  <a id="prevWeekLink" href="#"rel="nofollow"
     tal:attributes="href string:${request/getURL}?data=${view/prev_week}"
     >&larr; settimana precedente</a>
  <strong><tal:month i18n:domain="plonelocales"
                     i18n:translate=""
                     content="view/actual_translated_month" />
          <tal:year content="view/actual_date/year" /></strong>
  <a id="nextWeekLink" href="#" rel="nofollow"
     tal:attributes="href string:${request/getURL}?data=${view/next_week}"
     >settimana successiva &rarr;</a>
</metal:macro>

<!-- The macro that renders a period of the the day (morning, afternoon) -->
<metal:macro metal:define-macro="day_period" i18n:domain="rg.prenotazioni">
  <tr>
    <td tal:content="period"></td>
    <tal:days repeat="day view/actual_week_days">
      <td class="day"
          tal:define="interval python:view.prenotazioni.get_day_intervals(day)[period]"
          tal:attributes="class python:day==view.actual_date and 'day selected' or 'day';
                          style interval/css_styles|nothing"
          >
        <div class="plain period"
            tal:define="slots python:view.prenotazioni.get_busy_slots_in_period(day, period)">
          <div class="interval"
            tal:condition="python:interval and period!='stormynight'">
            From <tal:from replace="interval/start" />
            to <tal:from replace="interval/stop" />
          </div>
          <div class="slot" tal:repeat="slot slots">
            <div tal:define="booking nocall:slot/context"
                 tal:attributes="class python:view.prenotazioni.get_state(booking);
                                 style slot/css_styles">
              <h3>
                <a href=""
                   tal:omit-tag="not:view/user_can_manage"
                   tal:attributes="href booking/absolute_url">
                    <tal:from replace="python:view.DT2time(booking.getData_prenotazione())" />
                    &mdash;
                    <tal:to replace="python:view.DT2time(booking.getData_scadenza())" />
                </a>
              </h3>
            </div>
          </div>
        </div>
      </td>
    </tal:days>
  </tr>
  <tr tal:condition="python:period!='stormynight'">
    <td></td>
    <tal:days repeat="day view/actual_week_days">
      <td tal:define="booking_urls python:view.get_booking_urls(day, period);">
        <ul tal:condition="booking_urls">
          <li tal:repeat="booking_url booking_urls">
            <a rel="nofollow"
               tal:attributes="href booking_url/href">
               <tal:i18n i18n:translate="suggest_booking_for">
                 Book the first available slot for
               </tal:i18n>
               <tal:name replace="booking_url/text" />
            </a>
          </li>
        </ul>
      </td>
      </tal:days>
   </tr>
</metal:macro>

<!-- A slot for booking -->
<metal:macro metal:define-macro="booking_slots" i18n:domain="rg.prenotazioni">
  <dl tal:define="data_ora python:day[1].strftime('%Y/%m/%d')+' '+orario+':00';
                  has_free_slots python:view.conflict_manager.has_free_slots(data_ora);">

    <metal:booking_slots metal:use-macro="prenotazione_macros/desc_term" />
    <dd tal:condition="not:has_free_slots">
        <span class="slotOccupato">Occupato</span>
    </dd>
  </dl>
</metal:macro>

<!-- posso vedere tutte le prenotazioni in quanto ho permessi di edit-->
<metal:macro metal:define-macro="booking_slots_edit" i18n:domain="rg.prenotazioni">
  <dl tal:define="data_ora python:day[1].strftime('%Y/%m/%d')+' '+orario+':00';
                  has_free_slots python:view.conflict_manager.has_free_slots(data_ora);">

    <metal:booking_slots metal:use-macro="prenotazione_macros/desc_term" />
    <tal:repeat repeat="prenotazione prenotazioni">
      <dd>
        <tal:display condition="not:uid_spostamento">
            <!-- esiste la prenotazione -->
            <a href="" class="state-pending"
                tal:attributes="href prenotazione/getURL;
                class string:state-${prenotazione/review_state}"
                tal:content="prenotazione/Title">Mario Rossi</a>
            <!-- cambia data -->
            <a href="" class="modificaPrenotazione" title="Cambia data"
                tal:attributes="href python:here_url+'/spostaPrenotazione?UID='+prenotazione.UID">sposta</a>
        </tal:display>
      </dd>
    </tal:repeat>
  </dl>
</metal:macro>

<metal:macro metal:define-macro="desc_term" i18n:domain="rg.prenotazioni">
    <dt tal:define="show_add_button python:view.show_add_button(data_ora);">
      <tal:orario content="orario">8:00</tal:orario>
      <tal:has_space condition="has_free_slots">
        <a href="" class="aggiungiPrenotazione" title="Richiedi prenotazione"
            tal:condition="python:view.show_add_button(data_ora)"
            tal:attributes="href python:here_url+'/creaPrenotazione?form.booking_date='+data_ora">+</a>
        <tal:sposta condition="uid_spostamento">
          <a href="" class="modificaPrenotazione" title="Sposta qui"
          tal:attributes="href python:here_url+'/fissaPrenotazione?data_prenotazione='+data_ora">sposta qui</a>
        </tal:sposta>
      </tal:has_space>
    </dt>
</metal:macro>